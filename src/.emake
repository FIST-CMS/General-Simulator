##############################################
#Author	: EinsXiao@gmail.com
#Date 	: 2013/9/5
#Attention:
#	Please makesure that your #include lines
#	does not contain any single space whether 
#	the these line are commented of not!!!!!!
##############################################
sfix=".cu"
flags="-g -G -O0"
excu="exe"
libs="-lcurand"
##############################################
cc="g++"
##############################################
om="makefile.auto"
##############################################
if [[ "$sfix" == ".cu" ]]; then
  cc="nvcc"
elif [[ "$sfix" == ".cpp" ]]; then
  cc="g++"
else
  cc="gcc"
fi

echo "#emake log file for emake" >emake.log
echo "
#compile setting
CC = $cc
FLAGS = $flags 
SRCS = \$(wildcard *$sfix)
OBJECTS = \$(patsubst %$sfix, %.o, \$(SRCS))
EXCU = $excu
LIB	=  $libs
$excu: \$(OBJECTS)
	\$(CC) \$(FLAGS) -o \$(EXCU)  \$(OBJECTS) \$(LIB) ">$om
sorcs=$(ls *$sfix)
for src in $sorcs; do
  srco=${src/$sfix/.o}
  line="$srco: $src"
  headers=`cat $src |grep "#include"`
  #echo $headers
  for h in $headers; do
    echo "detected 	$h	 	in $src" >>emake.log
    hh=${h//$' '}
    hh=${h/$'#include'}
    hh=${hh//$'"'}
    if [[ "$hh" == "//"* ]]; then 
	 echo "$hh ignored" >>emake.log
    elif [[ "$hh" == "<"* ]]; then 
	 echo "$hh ignored">>emake.log
    else 
	 line=$line" "$hh
    fi
  done
  #echo $line
  #echo "$srco: $src">>$om
  echo $line >>$om
  echo "	\$(CC) \$(FLAGS) -c \$< -o \$@" >>$om
done
echo "
clean:
	rm *.o
	rm \$(EXCU)
">>$om
echo "##################################################">>emake.log
echo "###	Auto Makefile: $om	is created!!!">>emake.log
echo "##################################################">>emake.log
#echo "$om	:">>emake.log
#cat $om>>emake.log
make -f $om
